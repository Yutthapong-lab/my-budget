<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>จัดการข้อมูลระบบ | My Budget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root {
      --primary: #4f46e5;
      --primary-soft: #e0e7ff;
      --danger: #ef4444;
      --danger-soft: #fee2e2;
      --warning: #f59e0b;
      --warning-soft: #fef3c7;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --bg-body: #f8fafc;
      --card-bg: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --radius: 16px;
    }

    * { box-sizing: border-box; outline: none; }

    body {
      margin: 0; padding: 0;
      font-family: "Sarabun", sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      font-size: 14px;
      line-height: 1.5;
    }

    h1, h2, h3, h4, h5, button { font-family: "Kanit", sans-serif; }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* --- Header --- */
    .header-bar {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px dashed var(--border);
    }
    .page-title h1 { margin: 0; font-size: 24px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .page-title p { margin: 4px 0 0; color: var(--text-sub); font-size: 14px; }
    
    .btn-back {
      text-decoration: none; background: #fff; border: 1px solid var(--border);
      color: var(--text-main); padding: 8px 16px; border-radius: 50px;
      font-weight: 500; display: inline-flex; align-items: center; gap: 8px;
      transition: 0.2s; font-size: 13px;
    }
    .btn-back:hover { background: var(--primary-soft); color: var(--primary); border-color: var(--primary-soft); transform: translateX(-3px); }

    /* --- Layout Grid --- */
    .grid-layout {
      display: grid;
      grid-template-columns: 1fr 1fr; /* แบ่งครึ่งซ้ายขวา */
      gap: 24px;
      align-items: start;
    }

    /* --- Cards --- */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      border: 1px solid var(--border);
      display: flex; flex-direction: column;
      height: 100%;
    }
    .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .card-badge { font-size: 12px; background: var(--primary-soft); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-weight: 600; }

    /* --- Form Add --- */
    .add-box {
      background: #f8fafc; padding: 16px; border-radius: 12px; border: 1px solid var(--border);
      display: flex; gap: 10px; margin-bottom: 20px;
    }
    .input-main {
      flex: 1; padding: 10px 14px; border: 1px solid var(--border);
      border-radius: 8px; font-size: 14px; transition: 0.2s;
    }
    .input-main:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
    .btn-add {
      background: var(--primary); color: #fff; border: none; padding: 0 20px;
      border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.2s;
      white-space: nowrap; display: flex; align-items: center; gap: 6px;
    }
    .btn-add:hover { background: #4338ca; transform: translateY(-1px); }

    /* --- Table --- */
    .table-container { overflow-x: auto; flex: 1; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    th { text-align: left; padding: 12px; color: var(--text-sub); font-size: 12px; font-weight: 600; border-bottom: 2px solid var(--border); }
    td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f8fafc; }

    /* Action Buttons */
    .btn-action-group { display: flex; gap: 6px; justify-content: flex-end; }
    .btn-icon {
      width: 32px; height: 32px; border-radius: 8px; border: none;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: 0.2s; font-size: 13px;
    }
    .btn-edit { background: var(--warning-soft); color: var(--warning); }
    .btn-edit:hover { background: #fde68a; }
    .btn-del { background: var(--danger-soft); color: var(--danger); }
    .btn-del:hover { background: #fecaca; }

    /* --- Footer Pagination --- */
    .pagination {
      margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .page-info { font-size: 12px; color: var(--text-sub); }
    .page-controls button {
      background: #fff; border: 1px solid var(--border); padding: 4px 10px;
      border-radius: 6px; cursor: pointer; color: var(--text-sub); margin-left: 4px;
    }
    .page-controls button:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); }
    .page-controls button:disabled { opacity: 0.5; cursor: default; }

    /* Responsive */
    @media (max-width: 900px) {
      .grid-layout { grid-template-columns: 1fr; } /* มือถือเรียงแนวตั้ง */
    }
  </style>
</head>
<body>

<div class="container">
  
  <header class="header-bar">
    <div class="page-title">
      <h1><i class="fa-solid fa-sliders"></i> จัดการระบบ</h1>
      <p>แก้ไขหมวดหมู่และช่องทางชำระเงิน (มีผลทันที)</p>
    </div>
    <a href="index.html" class="btn-back">
      <i class="fa-solid fa-arrow-left"></i> กลับหน้าหลัก
    </a>
  </header>

  <div class="grid-layout">
    
    <section class="card">
      <div class="card-head">
        <div class="card-title"><i class="fa-solid fa-layer-group" style="color:#f59e0b;"></i> หมวดหมู่</div>
        <div class="card-badge">Income / Expense</div>
      </div>

      <div class="add-box">
        <input type="text" id="new-category-name" class="input-main" placeholder="ชื่อหมวดหมู่ใหม่...">
        <button type="button" id="add-category" class="btn-add"><i class="fa-solid fa-plus"></i> เพิ่ม</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ชื่อหมวดหมู่</th>
              <th style="text-align: right;">จัดการ</th>
            </tr>
          </thead>
          <tbody id="categories-table-body">
            </tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="page-info">
          แสดง 
          <select id="category-page-size" style="border:1px solid #cbd5e1; border-radius:4px;">
            <option value="5">5</option>
            <option value="10">10</option>
          </select> 
          (หน้า <span id="category-page-info">1</span>)
        </div>
        <div class="page-controls">
          <button id="category-prev"><i class="fa-solid fa-chevron-left"></i></button>
          <button id="category-next"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-head">
        <div class="card-title"><i class="fa-solid fa-wallet" style="color:#8b5cf6;"></i> วิธีชำระเงิน</div>
        <div class="card-badge">Payment Method</div>
      </div>

      <div class="add-box">
        <input type="text" id="new-method-name" class="input-main" placeholder="ชื่อวิธีชำระใหม่...">
        <button type="button" id="add-method" class="btn-add"><i class="fa-solid fa-plus"></i> เพิ่ม</button>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ชื่อวิธีชำระ</th>
              <th style="text-align: right;">จัดการ</th>
            </tr>
          </thead>
          <tbody id="methods-table-body">
            </tbody>
        </table>
      </div>

      <div class="pagination">
        <div class="page-info">
          แสดง 
          <select id="method-page-size" style="border:1px solid #cbd5e1; border-radius:4px;">
            <option value="5">5</option>
            <option value="10">10</option>
          </select> 
          (หน้า <span id="method-page-info">1</span>)
        </div>
        <div class="page-controls">
          <button id="method-prev"><i class="fa-solid fa-chevron-left"></i></button>
          <button id="method-next"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
      </div>
    </section>

  </div>
</div>

<script type="module">
  // Import ค่า config และ library
  import { db } from "./firebase-config.js";
  import {
    collection,
    addDoc,
    getDocs,
    deleteDoc,
    doc,
    serverTimestamp,
    updateDoc,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  const auth = getAuth();

  const categoriesCol = collection(db, "categories");
  const methodsCol = collection(db, "methods");

  const DEFAULT_CATEGORIES = [
    "รายได้ประจำ", "รายได้เสริม", "อาหาร", "เดินทาง",
    "ค่าอยู่บ้าน", "ความบันเทิง", "ของใช้ส่วนตัว", "หนี้ / ผ่อน", "อื่น ๆ"
  ];
  const DEFAULT_METHODS = [
    "โอนเงิน", "สแกนจ่าย", "บัตรเครดิต", "เงินสด", "อื่น ๆ"
  ];

  let categories = [];
  let methods = [];

  let categoryPageSize = 5;
  let categoryPage = 1;
  let methodPageSize = 5;
  let methodPage = 1;

  function sortThaiByName(list) {
    return list.sort((a, b) =>
      a.name.localeCompare(b.name, "th", { sensitivity: "base" })
    );
  }

  // >>> ฟังก์ชันอัปเดตชื่อหมวดหมู่ในประวัติย้อนหลัง <<<
  async function updateCategoryNameInHistory(oldName, newName) {
    if (!oldName || !newName || oldName === newName) return;
    const user = auth.currentUser;
    if (!user) return;

    // เปลี่ยนปุ่มเป็นสถานะโหลด (UX)
    const btn = document.querySelector(`.edit-cat-btn[data-name="${oldName}"]`);
    const originalContent = btn ? btn.innerHTML : "";
    if(btn) {
        btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i>`;
        btn.disabled = true;
    }

    try {
        const recordsRef = collection(db, "users", user.uid, "records");
        const q = query(recordsRef, where("category", "array-contains", oldName));
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
            console.log(`[History] Updating ${snapshot.size} records...`);
            const updatePromises = snapshot.docs.map(docSnap => {
                const data = docSnap.data();
                let updatedCats;
                if (Array.isArray(data.category)) {
                    updatedCats = data.category.map(c => c === oldName ? newName : c);
                } else {
                    updatedCats = data.category === oldName ? newName : data.category;
                }
                return updateDoc(docSnap.ref, { category: updatedCats });
            });
            await Promise.all(updatePromises);
        }
    } catch (error) {
        console.error("History Update Error:", error);
    } finally {
        if(btn) {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }
  }

  // โหลดข้อมูลทั้งหมด
  async function loadMasterData() {
    // categories
    let catSnap = await getDocs(categoriesCol);
    if (catSnap.empty) {
      await Promise.all(
        DEFAULT_CATEGORIES.map(name =>
          addDoc(categoriesCol, { name, createdAt: serverTimestamp() })
        )
      );
      catSnap = await getDocs(categoriesCol);
    }
    categories = [];
    catSnap.forEach(d => {
      const data = d.data();
      if (data && data.name) categories.push({ id: d.id, name: data.name });
    });
    sortThaiByName(categories);

    // methods
    let methodSnap = await getDocs(methodsCol);
    if (methodSnap.empty) {
      await Promise.all(
        DEFAULT_METHODS.map(name =>
          addDoc(methodsCol, { name, createdAt: serverTimestamp() })
        )
      );
      methodSnap = await getDocs(methodsCol);
    }
    methods = [];
    methodSnap.forEach(d => {
      const data = d.data();
      if (data && data.name) methods.push({ id: d.id, name: data.name });
    });
    sortThaiByName(methods);

    // Reset pagination bounds
    const catMaxPage = Math.max(1, Math.ceil((categories.length || 1) / categoryPageSize));
    if (categoryPage > catMaxPage) categoryPage = catMaxPage;
    const methodMaxPage = Math.max(1, Math.ceil((methods.length || 1) / methodPageSize));
    if (methodPage > methodMaxPage) methodPage = methodMaxPage;

    renderMasterTables();
  }

  // แสดงผลตาราง
  function renderMasterTables() {
    const catBody = document.getElementById("categories-table-body");
    const methBody = document.getElementById("methods-table-body");
    
    // Controls
    const catPageInfo = document.getElementById("category-page-info");
    const catPrevBtn = document.getElementById("category-prev");
    const catNextBtn = document.getElementById("category-next");

    const methodPageInfo = document.getElementById("method-page-info");
    const methodPrevBtn = document.getElementById("method-prev");
    const methodNextBtn = document.getElementById("method-next");

    // --- Render หมวดหมู่ ---
    if (catBody) {
      catBody.innerHTML = "";
      const totalCat = categories.length;
      
      if (!totalCat) {
        catBody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#94a3b8; padding:20px;">ยังไม่มีข้อมูล</td></tr>';
      } else {
        const start = (categoryPage - 1) * categoryPageSize;
        const pageItems = categories.slice(start, start + categoryPageSize);

        pageItems.forEach(c => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span style="font-weight:500;">${c.name}</span></td>
            <td style="text-align: right;">
              <div class="btn-action-group">
                <button type="button" class="btn-icon btn-edit edit-cat-btn" data-id="${c.id}" data-name="${c.name}" title="แก้ไข"><i class="fa-solid fa-pen"></i></button>
                <button type="button" class="btn-icon btn-del del-cat-btn" data-id="${c.id}" data-name="${c.name}" title="ลบ"><i class="fa-solid fa-trash"></i></button>
              </div>
            </td>
          `;
          catBody.appendChild(tr);
        });
        
        // Events Categories
        catBody.querySelectorAll(".edit-cat-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const oldName = btn.dataset.name;
                const newName = prompt("แก้ไขชื่อหมวดหมู่", oldName);
                if(newName && newName.trim() && newName.trim() !== oldName) {
                    const finalName = newName.trim();
                    await updateDoc(doc(categoriesCol, id), { name: finalName });
                    await updateCategoryNameInHistory(oldName, finalName); // Update History
                    await loadMasterData();
                }
            });
        });

        catBody.querySelectorAll(".del-cat-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                if(confirm(`ยืนยันลบหมวดหมู่ "${btn.dataset.name}" ?`)) {
                    await deleteDoc(doc(categoriesCol, btn.dataset.id));
                    await loadMasterData();
                }
            });
        });
      }

      if(catPageInfo) catPageInfo.textContent = `${categoryPage} / ${Math.ceil(totalCat/categoryPageSize) || 1}`;
      if(catPrevBtn) catPrevBtn.disabled = categoryPage <= 1;
      if(catNextBtn) catNextBtn.disabled = categoryPage >= (Math.ceil(totalCat/categoryPageSize) || 1);
    }

    // --- Render วิธีจ่าย ---
    if (methBody) {
      methBody.innerHTML = "";
      const totalMethod = methods.length;
      
      if (!totalMethod) {
         methBody.innerHTML = '<tr><td colspan="2" style="text-align:center; color:#94a3b8; padding:20px;">ยังไม่มีข้อมูล</td></tr>';
      } else {
        const start = (methodPage - 1) * methodPageSize;
        const pageItems = methods.slice(start, start + methodPageSize);

        pageItems.forEach(m => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span style="font-weight:500;">${m.name}</span></td>
            <td style="text-align: right;">
              <div class="btn-action-group">
                <button type="button" class="btn-icon btn-edit edit-meth-btn" data-id="${m.id}" data-name="${m.name}" title="แก้ไข"><i class="fa-solid fa-pen"></i></button>
                <button type="button" class="btn-icon btn-del del-meth-btn" data-id="${m.id}" data-name="${m.name}" title="ลบ"><i class="fa-solid fa-trash"></i></button>
              </div>
            </td>
          `;
          methBody.appendChild(tr);
        });

        // Events Methods
        methBody.querySelectorAll(".edit-meth-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const oldName = btn.dataset.name;
                const newName = prompt("แก้ไขชื่อวิธีชำระ", oldName);
                if(newName && newName.trim()) {
                    await updateDoc(doc(methodsCol, id), { name: newName.trim() });
                    await loadMasterData();
                }
            });
        });

        methBody.querySelectorAll(".del-meth-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                if(confirm(`ยืนยันลบวิธีชำระ "${btn.dataset.name}" ?`)) {
                    await deleteDoc(doc(methodsCol, btn.dataset.id));
                    await loadMasterData();
                }
            });
        });
      }
      
      if(methodPageInfo) methodPageInfo.textContent = `${methodPage} / ${Math.ceil(totalMethod/methodPageSize) || 1}`;
      if(methodPrevBtn) methodPrevBtn.disabled = methodPage <= 1;
      if(methodNextBtn) methodNextBtn.disabled = methodPage >= (Math.ceil(totalMethod/methodPageSize) || 1);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    onAuthStateChanged(auth, (user) => {
        loadMasterData(); // Load regardless of user status for demo, but edit history needs user
    });

    const addCatBtn = document.getElementById("add-category");
    if(addCatBtn) {
        addCatBtn.addEventListener("click", async () => {
          const input = document.getElementById("new-category-name");
          const name = input.value.trim();
          if (!name) return alert("กรุณากรอกชื่อหมวดหมู่");
          await addDoc(categoriesCol, { name, createdAt: serverTimestamp() });
          input.value = "";
          loadMasterData();
        });
    }

    const addMethBtn = document.getElementById("add-method");
    if(addMethBtn) {
        addMethBtn.addEventListener("click", async () => {
          const input = document.getElementById("new-method-name");
          const name = input.value.trim();
          if (!name) return alert("กรุณากรอกชื่อวิธีชำระ");
          await addDoc(methodsCol, { name, createdAt: serverTimestamp() });
          input.value = "";
          loadMasterData();
        });
    }

    // Pagination Listeners
    const catPrev = document.getElementById("category-prev");
    if(catPrev) catPrev.onclick = () => { if(categoryPage > 1) { categoryPage--; renderMasterTables(); }};
    const catNext = document.getElementById("category-next");
    if(catNext) catNext.onclick = () => { const max = Math.ceil(categories.length/categoryPageSize); if(categoryPage < max) { categoryPage++; renderMasterTables(); }};

    const methPrev = document.getElementById("method-prev");
    if(methPrev) methPrev.onclick = () => { if(methodPage > 1) { methodPage--; renderMasterTables(); }};
    const methNext = document.getElementById("method-next");
    if(methNext) methNext.onclick = () => { const max = Math.ceil(methods.length/methodPageSize); if(methodPage < max) { methodPage++; renderMasterTables(); }};
    
    // Page Size Listeners
    const catSize = document.getElementById("category-page-size");
    if(catSize) catSize.onchange = (e) => { categoryPageSize = parseInt(e.target.value); categoryPage = 1; renderMasterTables(); };
    const methSize = document.getElementById("method-page-size");
    if(methSize) methSize.onchange = (e) => { methodPageSize = parseInt(e.target.value); methodPage = 1; renderMasterTables(); };
  });
</script>
</body>
</html>
