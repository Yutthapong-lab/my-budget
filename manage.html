<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà & ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏±‡∏ö</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #e0edff;
      --accent-soft-border: #bfdbfe;
      --danger: #ef4444;
      --text-main: #0f172a;
      --text-sub: #6b7280;
      --radius-lg: 18px;
      --radius-md: 12px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0; padding: 0;
      font-family: "Kanit", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #e0edff 0, #f9fafb 45%);
      color: var(--text-main); font-size: 15px; line-height: 1.5;
    }

    .page { min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { position: sticky; top: 0; z-index: 20; backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.9); border-bottom: 1px solid #e5e7eb; }
    .topbar-inner { max-width: 900px; margin: 0 auto; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .brand-block { display: flex; flex-direction: column; gap: 2px; }
    .brand-text-title { font-size: 20px; font-weight: 600; letter-spacing: 0.02em; }
    .brand-text-sub { font-size: 13px; color: var(--text-sub); }
    .topbar-link { border-radius: 999px; padding: 8px 14px; font-size: 13px; border: 1px solid #d1d5db; color: var(--text-main); text-decoration: none; display: inline-flex; align-items: center; gap: 6px; background: #f9fafb; transition: 0.15s; white-space: nowrap; }
    .topbar-link:hover { background: #e5e7eb; transform: translateY(-1px); box-shadow: 0 8px 16px rgba(15, 23, 42, 0.08); }
    .content { flex: 1; max-width: 900px; margin: 16px auto 24px auto; padding: 0 16px 24px; }
    .page-header { margin-bottom: 16px; display: flex; flex-direction: column; gap: 4px; }
    .page-title { font-size: 22px; font-weight: 600; }
    .page-subtitle { font-size: 14px; color: var(--text-sub); }
    .card { background: var(--card-bg); border-radius: var(--radius-lg); box-shadow: 0 14px 30px rgba(148, 163, 184, 0.25); padding: 18px 18px 16px; margin-bottom: 16px; border: 1px solid #e5e7eb; }
    .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
    .card-title-wrapper { display: flex; flex-direction: column; gap: 4px; }
    .card-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; background: var(--accent-soft); border: 1px solid var(--accent-soft-border); font-size: 12px; color: #1d4ed8; font-weight: 500; }
    .card-title { font-weight: 600; font-size: 18px; }
    .card-subtitle { font-size: 14px; color: var(--text-sub); }
    .row { display: flex; flex-wrap: wrap; gap: 12px; }
    .field { display: flex; flex-direction: column; flex: 1 1 260px; min-width: 200px; gap: 6px; }
    label { font-size: 13px; color: #4b5563; }
    .inline-input { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .inline-input input[type="text"] { flex: 1 1 220px; min-width: 0; }
    input[type="text"] { padding: 10px 12px; border-radius: var(--radius-md); border: 1px solid #d1d5db; font-size: 14px; outline: none; background: #f9fafb; transition: 0.15s; }
    input[type="text"]:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4); background: #ffffff; }
    .btn { border: none; border-radius: 999px; padding: 8px 16px; font-size: 13px; cursor: pointer; transition: 0.15s; display: inline-flex; align-items: center; gap: 6px; text-decoration: none; white-space: nowrap; font-family: "Kanit", sans-serif; }
    .btn:active { transform: translateY(0); opacity: 0.95; }
    .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25); }
    .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-secondary:hover { background: #d1d5db; transform: translateY(-1px); }
    .btn-danger { background: var(--danger); color: #fff; box-shadow: 0 8px 16px rgba(248, 113, 113, 0.28); }
    .btn-danger:hover { background: #dc2626; transform: translateY(-1px); }
    .btn-small { padding: 6px 12px; font-size: 12px; }
    .btn-group-inline { display: flex; gap: 6px; justify-content: flex-end; }
    .table-wrapper { overflow-x: auto; margin-top: 10px; border-radius: 14px; border: 1px solid #e5e7eb; background: #f9fafb; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 320px; }
    thead { background: #f3f4f6; }
    th, td { padding: 9px 12px; border-bottom: 1px solid #e5e7eb; text-align: left; white-space: nowrap; }
    th { font-weight: 600; font-size: 12px; color: #4b5563; }
    tbody tr:nth-child(even) { background: #ffffff; }
    tbody tr:nth-child(odd) { background: #f9fafb; }
    .table-empty-text { padding: 10px 12px; font-size: 13px; color: var(--text-sub); }
    .table-footer { display: flex; align-items: center; justify-content: space-between; padding: 8px 4px 0; gap: 10px; font-size: 13px; color: var(--text-sub); flex-wrap: wrap; }
    .table-page-size { display: flex; align-items: center; gap: 6px; }
    .table-page-size select { padding: 4px 8px; border-radius: 999px; border: 1px solid #d1d5db; background: #ffffff; font-size: 13px; font-family: "Kanit", sans-serif; outline: none; }
    .table-pagination { display: flex; align-items: center; gap: 6px; }
    .table-pagination button { padding: 4px 10px; border-radius: 999px; border: 1px solid #d1d5db; background: #ffffff; cursor: pointer; font-size: 12px; font-family: "Kanit", sans-serif; transition: 0.15s; }
    .table-pagination button:hover:not(:disabled) { background: #e5e7eb; transform: translateY(-1px); }
    .table-pagination button:disabled { opacity: 0.45; cursor: default; }

    @media (max-width: 768px) {
      .content { padding: 0 12px 20px; }
      .card { padding: 16px 14px 14px; }
      .topbar-inner { padding-inline: 12px; }
      .brand-text-title { font-size: 18px; }
      .page-title { font-size: 20px; }
      .topbar-link span.hide-mobile { display: none; }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-block">
        <div class="brand-text-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà &amp; ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏±‡∏ö</div>
        <div class="brand-text-sub">‡πÅ‡∏Å‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ dropdown ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°</div>
      </div>
      <a href="index.html" class="topbar-link">
        ‚¨ÖÔ∏è
        <span class="hide-mobile">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</span>
      </a>
    </div>
  </header>

  <main class="content">
    <div class="page-header">
      <div class="page-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏±‡∏ö</div>
      <div class="page-subtitle">‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡∏•‡∏ö / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‚Äì‡∏≠‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô</div>
    </div>

    <section class="card">
      <div class="card-header">
        <div class="card-title-wrapper">
          <div class="card-badge">üìÇ ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
          <div class="card-title">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
          <div class="card-subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‚Äì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="new-category-name">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</label>
          <div class="inline-input">
            <input type="text" id="new-category-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≠‡∏°, ‡∏•‡∏á‡∏ó‡∏∏‡∏ô, ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á ‡∏Ø‡∏•‡∏Ø">
            <button type="button" class="btn btn-primary btn-small" id="add-category">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</button>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
            <th style="text-align: right;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
          </thead>
          <tbody id="categories-table-body"></tbody>
        </table>
      </div>

      <div class="table-footer">
        <div class="table-page-size">
          ‡πÅ‡∏™‡∏î‡∏á
          <select id="category-page-size">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="15">15</option>
          </select>
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
        </div>
        <div class="table-pagination">
          <button id="category-prev">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <span class="table-page-info" id="category-page-info">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
          <button id="category-next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title-wrapper">
          <div class="card-badge">üí∏ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‚Äì‡∏à‡πà‡∏≤‡∏¢</div>
          <div class="card-title">‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏±‡∏ö</div>
          <div class="card-subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏£‡∏±‡∏ö‚Äì‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏≠‡∏ô, QR, ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="new-method-name">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏±‡∏ö ‡πÉ‡∏´‡∏°‡πà</label>
          <div class="inline-input">
            <input type="text" id="new-method-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå, ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡πÉ‡∏ö‡∏ó‡∏µ‡πà 2">
            <button type="button" class="btn btn-primary btn-small" id="add-method">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏±‡∏ö</button>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ / ‡∏£‡∏±‡∏ö</th>
            <th style="text-align: right;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
          </thead>
          <tbody id="methods-table-body"></tbody>
        </table>
      </div>

      <div class="table-footer">
        <div class="table-page-size">
          ‡πÅ‡∏™‡∏î‡∏á
          <select id="method-page-size">
            <option value="3">3</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="15">15</option>
          </select>
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
        </div>
        <div class="table-pagination">
          <button id="method-prev">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <span class="table-page-info" id="method-page-info">‡∏´‡∏ô‡πâ‡∏≤ 1 / 1</span>
          <button id="method-next">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script type="module">
  // Import ‡∏Ñ‡πà‡∏≤ config ‡πÅ‡∏•‡∏∞ library
  import { db } from "./firebase-config.js";
  import {
    collection,
    addDoc,
    getDocs,
    deleteDoc,
    doc,
    serverTimestamp,
    updateDoc,
    // >>> Import ‡πÄ‡∏û‡∏¥‡πà‡∏° <<<
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

  // >>> Import Auth ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ User ID <<<
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
  const auth = getAuth();

  const categoriesCol = collection(db, "categories");
  const methodsCol = collection(db, "methods");

  const DEFAULT_CATEGORIES = [
    "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥", "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
    "‡∏Ñ‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á", "‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", "‡∏´‡∏ô‡∏µ‡πâ / ‡∏ú‡πà‡∏≠‡∏ô", "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"
  ];
  const DEFAULT_METHODS = [
    "‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô", "‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£", "Thai QR Payment", "‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"
  ];

  let categories = [];
  let methods = [];

  let categoryPageSize = 5;
  let categoryPage = 1;
  let methodPageSize = 5;
  let methodPage = 1;

  function sortThaiByName(list) {
    return list.sort((a, b) =>
      a.name.localeCompare(b.name, "th", { sensitivity: "base" })
    );
  }

  // >>> ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á <<<
  async function updateCategoryNameInHistory(oldName, newName) {
    if (!oldName || !newName || oldName === newName) return;

    // ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÉ‡∏´‡πâ Auth ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô
    const user = auth.currentUser;
    if (!user) return; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡∏Å‡πá‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ

    const btn = document.querySelector(`.edit-cat-btn[data-name="${oldName}"]`);
    const originalText = btn ? btn.textContent : "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
    if(btn) {
        btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...`;
        btn.disabled = true;
    }

    try {
        const recordsRef = collection(db, "users", user.uid, "records");
        const q = query(recordsRef, where("category", "array-contains", oldName));
        const snapshot = await getDocs(q);

        if (!snapshot.empty) {
            console.log(`[History] ‡∏û‡∏ö ${snapshot.size} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡∏à‡∏≤‡∏Å "${oldName}" ‡πÄ‡∏õ‡πá‡∏ô "${newName}"`);
            
            const updatePromises = snapshot.docs.map(docSnap => {
                const data = docSnap.data();
                let updatedCats;
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô array ‡πÉ‡∏´‡πâ map ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠, ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏•‡∏¢
                if (Array.isArray(data.category)) {
                    updatedCats = data.category.map(c => c === oldName ? newName : c);
                } else {
                    updatedCats = data.category === oldName ? newName : data.category;
                }
                return updateDoc(docSnap.ref, { category: updatedCats });
            });

            await Promise.all(updatePromises);
            console.log("[History] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
        }
    } catch (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:", error);
    } finally {
        if(btn) {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  async function loadMasterData() {
    // categories
    let catSnap = await getDocs(categoriesCol);
    if (catSnap.empty) {
      await Promise.all(
        DEFAULT_CATEGORIES.map(name =>
          addDoc(categoriesCol, { name, createdAt: serverTimestamp() })
        )
      );
      catSnap = await getDocs(categoriesCol);
    }
    categories = [];
    catSnap.forEach(d => {
      const data = d.data();
      if (data && data.name) categories.push({ id: d.id, name: data.name });
    });
    sortThaiByName(categories);

    // methods
    let methodSnap = await getDocs(methodsCol);
    if (methodSnap.empty) {
      await Promise.all(
        DEFAULT_METHODS.map(name =>
          addDoc(methodsCol, { name, createdAt: serverTimestamp() })
        )
      );
      methodSnap = await getDocs(methodsCol);
    }
    methods = [];
    methodSnap.forEach(d => {
      const data = d.data();
      if (data && data.name) methods.push({ id: d.id, name: data.name });
    });
    sortThaiByName(methods);

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤
    const catMaxPage = Math.max(1, Math.ceil((categories.length || 1) / categoryPageSize));
    if (categoryPage > catMaxPage) categoryPage = catMaxPage;

    const methodMaxPage = Math.max(1, Math.ceil((methods.length || 1) / methodPageSize));
    if (methodPage > methodMaxPage) methodPage = methodMaxPage;

    renderMasterTables();
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  function renderMasterTables() {
    const catBody = document.getElementById("categories-table-body");
    const methBody = document.getElementById("methods-table-body");
    
    // Elements ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    const catPageInfo = document.getElementById("category-page-info");
    const catPrevBtn = document.getElementById("category-prev");
    const catNextBtn = document.getElementById("category-next");

    // Elements ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢
    const methodPageInfo = document.getElementById("method-page-info");
    const methodPrevBtn = document.getElementById("method-prev");
    const methodNextBtn = document.getElementById("method-next");

    // --- Render ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ---
    if (catBody) {
      catBody.innerHTML = "";
      const totalCat = categories.length;
      
      if (!totalCat) {
        catBody.innerHTML = '<tr><td colspan="2" class="table-empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</td></tr>';
      } else {
        const start = (categoryPage - 1) * categoryPageSize;
        const pageItems = categories.slice(start, start + categoryPageSize);

        pageItems.forEach(c => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${c.name}</td>
            <td style="text-align: right;">
              <div class="btn-group-inline">
                <button type="button" class="btn btn-secondary btn-small edit-cat-btn" data-id="${c.id}" data-name="${c.name}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button type="button" class="btn btn-danger btn-small del-cat-btn" data-id="${c.id}" data-name="${c.name}">‡∏•‡∏ö</button>
              </div>
            </td>
          `;
          catBody.appendChild(tr);
        });
        
        // ‡∏ú‡∏π‡∏Å event ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        catBody.querySelectorAll(".edit-cat-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const oldName = btn.dataset.name;
                const newName = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", oldName);
                if(newName && newName.trim() && newName.trim() !== oldName) {
                    const finalName = newName.trim();
                    
                    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô Master (Categories Collection)
                    await updateDoc(doc(categoriesCol, id), { name: finalName });

                    // 2. >>> ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á <<<
                    // (‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ)
                    // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Fire and Forget) ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏™‡πà await ‡∏Å‡πá‡πÑ‡∏î‡πâ
                    await updateCategoryNameInHistory(oldName, finalName);

                    await loadMasterData();
                }
            });
        });

        catBody.querySelectorAll(".del-cat-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                if(confirm(`‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${btn.dataset.name}" ?`)) {
                    await deleteDoc(doc(categoriesCol, btn.dataset.id));
                    await loadMasterData();
                }
            });
        });
      }

      if(catPageInfo) catPageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${categoryPage} / ${Math.ceil(totalCat/categoryPageSize) || 1}`;
      if(catPrevBtn) catPrevBtn.disabled = categoryPage <= 1;
      if(catNextBtn) catNextBtn.disabled = categoryPage >= (Math.ceil(totalCat/categoryPageSize) || 1);
    }

    // --- Render ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ ---
    if (methBody) {
      methBody.innerHTML = "";
      const totalMethod = methods.length;
      
      if (!totalMethod) {
         methBody.innerHTML = '<tr><td colspan="2" class="table-empty-text">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢</td></tr>';
      } else {
        const start = (methodPage - 1) * methodPageSize;
        const pageItems = methods.slice(start, start + methodPageSize);

        pageItems.forEach(m => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${m.name}</td>
            <td style="text-align: right;">
              <div class="btn-group-inline">
                <button type="button" class="btn btn-secondary btn-small edit-meth-btn" data-id="${m.id}" data-name="${m.name}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button type="button" class="btn btn-danger btn-small del-meth-btn" data-id="${m.id}" data-name="${m.name}">‡∏•‡∏ö</button>
              </div>
            </td>
          `;
          methBody.appendChild(tr);
        });

        methBody.querySelectorAll(".edit-meth-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                const id = btn.dataset.id;
                const oldName = btn.dataset.name;
                const newName = prompt("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢", oldName);
                if(newName && newName.trim()) {
                    await updateDoc(doc(methodsCol, id), { name: newName.trim() });
                    await loadMasterData();
                }
            });
        });

        methBody.querySelectorAll(".del-meth-btn").forEach(btn => {
            btn.addEventListener("click", async () => {
                if(confirm(`‡∏•‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢ "${btn.dataset.name}" ?`)) {
                    await deleteDoc(doc(methodsCol, btn.dataset.id));
                    await loadMasterData();
                }
            });
        });
      }
      
      if(methodPageInfo) methodPageInfo.textContent = `‡∏´‡∏ô‡πâ‡∏≤ ${methodPage} / ${Math.ceil(totalMethod/methodPageSize) || 1}`;
      if(methodPrevBtn) methodPrevBtn.disabled = methodPage <= 1;
      if(methodNextBtn) methodNextBtn.disabled = methodPage >= (Math.ceil(totalMethod/methodPageSize) || 1);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // ‡∏£‡∏≠ Check Auth ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ User ID)
    onAuthStateChanged(auth, (user) => {
        if(user) {
            console.log("Admin logged in:", user.email);
            loadMasterData();
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login ‡πÉ‡∏´‡πâ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠ ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡πÇ‡∏´‡∏•‡∏î master data ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
            loadMasterData();
        }
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    const addCatBtn = document.getElementById("add-category");
    if(addCatBtn) {
        addCatBtn.addEventListener("click", async () => {
          const input = document.getElementById("new-category-name");
          const name = input.value.trim();
          if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà");
          await addDoc(categoriesCol, { name, createdAt: serverTimestamp() });
          input.value = "";
          loadMasterData();
        });
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢
    const addMethBtn = document.getElementById("add-method");
    if(addMethBtn) {
        addMethBtn.addEventListener("click", async () => {
          const input = document.getElementById("new-method-name");
          const name = input.value.trim();
          if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡∏à‡πà‡∏≤‡∏¢");
          await addDoc(methodsCol, { name, createdAt: serverTimestamp() });
          input.value = "";
          loadMasterData();
        });
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤
    const catPrev = document.getElementById("category-prev");
    if(catPrev) catPrev.onclick = () => { if(categoryPage > 1) { categoryPage--; renderMasterTables(); }};

    const catNext = document.getElementById("category-next");
    if(catNext) catNext.onclick = () => { const max = Math.ceil(categories.length/categoryPageSize); if(categoryPage < max) { categoryPage++; renderMasterTables(); }};

    const methPrev = document.getElementById("method-prev");
    if(methPrev) methPrev.onclick = () => { if(methodPage > 1) { methodPage--; renderMasterTables(); }};

    const methNext = document.getElementById("method-next");
    if(methNext) methNext.onclick = () => { const max = Math.ceil(methods.length/methodPageSize); if(methodPage < max) { methodPage++; renderMasterTables(); }};
    
    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤
    const catSize = document.getElementById("category-page-size");
    if(catSize) catSize.onchange = (e) => { categoryPageSize = parseInt(e.target.value); categoryPage = 1; renderMasterTables(); };

    const methSize = document.getElementById("method-page-size");
    if(methSize) methSize.onchange = (e) => { methodPageSize = parseInt(e.target.value); methodPage = 1; renderMasterTables(); };
  });
</script>
</body>
</html>
